import React, { useState, useEffect } from 'react';
import { useAuth } from '../contexts/AuthContext';
import QuestionInput from '../../components/QuestionInput';
import AnswerDisplay from '../../components/AnswerDisplay';
import AnswerGranularitySelector, { Granularity } from '../../components/AnswerGranularitySelector';
import SuggestedFollowUpQuestions from '../../components/SuggestedFollowUpQuestions';
import UserInsightDisplay from '../../components/UserInsightDisplay';
import FaqItem from '../../components/FaqItem';
import { KNOWLEDGE_BASE } from '../../constants';
import { QAItem } from '../../types';

// AI回答生成のヘルパー関数
const findMostRelevantFAQ = (question: string): QAItem | null => {
  const questionLower = question.toLowerCase();
  let bestMatch: QAItem | null = null;
  let bestScore = 0;

  KNOWLEDGE_BASE.forEach(faq => {
    let score = 0;
    
    // キーワードマッチング
    faq.keywords.forEach(keyword => {
      if (questionLower.includes(keyword.toLowerCase())) {
        score += 3;
      }
    });
    
    // 質問内容のマッチング
    if (questionLower.includes(faq.question.toLowerCase())) {
      score += 5;
    }
    
    // カテゴリマッチング
    if (questionLower.includes(faq.category.toLowerCase())) {
      score += 2;
    }
    
    if (score > bestScore) {
      bestScore = score;
      bestMatch = faq;
    }
  });

  return bestScore > 2 ? bestMatch : null;
};

const generateAnswerByGranularity = (faq: QAItem, granularity: Granularity): string => {
  const baseAnswer = faq.answer;
  
  switch (granularity) {
    case 'concise':
      return `## 簡潔な回答\n\n${faq.question}\n\n**要点**: ${baseAnswer.split('\n')[0]}\n\n**キーポイント**:\n${faq.keywords.slice(0, 3).map(k => `- ${k}`).join('\n')}`;
    
    case 'contextual':
      return generateContextualAnswer(faq);
    
    case 'detailed':
      return generateDetailedAnswer(faq);
    
    default:
      return baseAnswer;
  }
};

const generateContextualAnswer = (faq: QAItem): string => {
  const baseAnswer = faq.answer;
  const referenceLinks = extractReferenceLinks(baseAnswer);
  
  return `## 文脈を含めた回答\n\n**質問**: ${faq.question}\n\n**回答**:\n\n${baseAnswer}\n\n**背景と重要性**:\n${generateBackgroundContext(faq)}\n\n**実践的なポイント**:\n${generatePracticalPoints(faq)}\n\n**参考資料**:\n${referenceLinks}\n\n**次のステップ**:\n${generateNextSteps(faq)}\n\n**詳細分析**:\n${generateDetailedAnalysis(faq)}\n\n**実践事例**:\n${generatePracticalExamples(faq)}\n\n**業界動向**:\n${generateIndustryTrends(faq)}`;
};

const generateDetailedAnswer = (faq: QAItem): string => {
  const baseAnswer = faq.answer;
  const referenceLinks = extractReferenceLinks(baseAnswer);
  
  return `## 詳細な回答\n\n**質問**: ${faq.question}\n\n**カテゴリ**: ${faq.category} > ${faq.subCategory}\n\n**詳細回答**:\n\n${baseAnswer}\n\n**背景と重要性**:\n${generateBackgroundContext(faq)}\n\n**実践的なポイント**:\n${generatePracticalPoints(faq)}\n\n**具体的な施策**:\n${generateConcreteMeasures(faq)}\n\n**成功のコツ**:\n${generateSuccessTips(faq)}\n\n**よくある失敗と対策**:\n${generateCommonMistakes(faq)}\n\n**測定と改善**:\n${generateMeasurementAndImprovement(faq)}\n\n**詳細分析**:\n${generateDetailedAnalysis(faq)}\n\n**実践事例**:\n${generatePracticalExamples(faq)}\n\n**業界動向**:\n${generateIndustryTrends(faq)}\n\n**専門的な洞察**:\n${generateExpertInsights(faq)}\n\n**戦略的アプローチ**:\n${generateStrategicApproach(faq)}\n\n**リスク管理**:\n${generateRiskManagement(faq)}\n\n**長期的な視点**:\n${generateLongTermPerspective(faq)}\n\n**キーワード**: ${faq.keywords.join(', ')}\n\n**参考資料**:\n${referenceLinks}\n\n**関連トピック**:\n${generateRelatedTopics(faq)}\n\n**次のステップ**:\n${generateNextSteps(faq)}`;
};

const extractReferenceLinks = (text: string): string => {
  const linkRegex = /\[([^\]]+)\]\(([^)]+)\)/g;
  const links: string[] = [];
  let match;
  
  while ((match = linkRegex.exec(text)) !== null) {
    links.push(`- [${match[1]}](${match[2]})`);
  }
  
  return links.length > 0 ? links.join('\n') : '参考資料はありません';
};

const generateRelatedTopics = (faq: QAItem): string => {
  const relatedFAQs = KNOWLEDGE_BASE.filter(item => 
    item.category === faq.category && item.id !== faq.id
  ).slice(0, 3);
  
  return relatedFAQs.map(item => `- ${item.question}`).join('\n');
};

const generateFollowUpQuestions = (faq: QAItem, originalQuestion: string): string[] => {
  const relatedFAQs = KNOWLEDGE_BASE.filter(item => 
    item.category === faq.category && item.id !== faq.id
  ).slice(0, 3);
  
  return relatedFAQs.map(item => item.question);
};

const generateUserInsights = (faq: QAItem, question: string): string[] => {
  const insights = [
    `この質問から、${faq.category}分野に強い関心があることが分かります`,
    `${faq.subCategory}について、より深く知りたいようですね`,
    '実践的なアドバイスを求められているようですね'
  ];
  
  return insights;
};

const generateFallbackAnswer = (question: string, granularity: Granularity): string => {
  const baseAnswer = `「${question}」について、以下のように回答いたします：

## 概要
人事関連の質問について、包括的な情報を提供いたします。

## 詳細な説明
選択された詳細度（${granularity}）に基づいて、適切なレベルの情報をお届けします。

### 参考情報
当システムには以下の分野の豊富な知識ベースがあります：
- 採用ブランディング
- 採用広報
- スカウト
- 面接・面談
- エンジニア採用
- デザイナー採用

### より具体的な質問
より詳細な回答を得るために、以下のような具体的な質問をしていただけますでしょうか？
- 「採用広報の具体的な方法は？」
- 「スカウトメールの効果的な書き方は？」
- 「採用ブランディングの進め方は？」

## まとめ
人事関連の質問について、お気軽にお聞かせください。`;

  return baseAnswer;
};

// 深層的な内容生成のヘルパー関数
const generateBackgroundContext = (faq: QAItem): string => {
  const contextMap: { [key: string]: string } = {
    '採用ブランディング': '採用ブランディングは、企業の魅力を候補者に効果的に伝えるための戦略的アプローチです。単なる情報発信ではなく、企業の価値観、文化、成長機会を体系的に整理し、候補者の心に響く形で表現することが重要です。',
    '採用広報': '採用広報は、企業の採用活動を成功に導くための情報発信戦略です。従来の求人広告とは異なり、企業の魅力や働く環境を多角的に伝え、候補者のエンゲージメントを高めることが目的です。',
    'スカウト': 'スカウトは、受動的な採用活動ではなく、積極的に優秀な人材にアプローチする戦略的採用手法です。候補者のニーズを深く理解し、企業の魅力を効果的に訴求することが成功の鍵となります。',
    '面接・面談': '面接・面談は、候補者と企業の相互理解を深める重要な機会です。単なる能力確認ではなく、候補者の価値観やキャリアビジョンとの適合性を確認し、双方にとって最適なマッチングを実現することが重要です。'
  };
  
  return contextMap[faq.category] || 'この分野は、人事戦略において重要な役割を果たしています。';
};

const generatePracticalPoints = (faq: QAItem): string => {
  const practicalMap: { [key: string]: string } = {
    '採用ブランディング': '• 企業の理念・ビジョンを明確に言語化する\n• 社員の成長ストーリーを収集・整理する\n• 候補者目線での魅力を再定義する\n• 一貫性のあるブランドメッセージを構築する',
    '採用広報': '• 多様なチャネルを活用した情報発信\n• 候補者のニーズに合わせたコンテンツ作成\n• 定期的な効果測定と改善\n• 社内関係者との連携強化',
    'スカウト': '• ターゲット候補者の詳細なペルソナ設定\n• パーソナライズされたアプローチ\n• 段階的な関係構築\n• 継続的なフォローアップ',
    '面接・面談': '• 候補者体験の最適化\n• 面接官のスキル向上\n• 選考プロセスの透明性確保\n• フィードバックの活用'
  };
  
  return practicalMap[faq.category] || '• 現状分析と課題の明確化\n• 具体的なアクションプランの策定\n• 段階的な実施と効果測定\n• 継続的な改善と最適化';
};

const generateConcreteMeasures = (faq: QAItem): string => {
  const measuresMap: { [key: string]: string } = {
    '採用ブランディング': '1. **魅力の棚卸し**: 企業の強み、特徴、価値観を体系的に整理\n2. **ターゲット分析**: 候補者のニーズ、価値観、キャリア目標を調査\n3. **メッセージ設計**: 企業の魅力を候補者目線で表現\n4. **発信戦略**: 適切なチャネルとタイミングでの情報発信\n5. **効果測定**: 候補者の反応と採用成果の分析',
    '採用広報': '1. **コンテンツ戦略**: 記事のテーマと執筆順序の決定\n2. **チャネル最適化**: ブログ、SNS、動画、Podcastの効果的活用\n3. **社員インタビュー**: リアルな声を通じた魅力発信\n4. **採用ピッチ資料**: 候補者向けの魅力的な資料作成\n5. **候補者体験**: 面談から入社までの体験設計',
    'スカウト': '1. **ターゲット設定**: 職種・レベル・経験の詳細な定義\n2. **アプローチ戦略**: パーソナライズされたメッセージ作成\n3. **関係構築**: 段階的な信頼関係の構築\n4. **魅力訴求**: 企業・職種・ポジションの魅力言語化\n5. **フォローアップ**: 継続的なコミュニケーション',
    '面接・面談': '1. **面接設計**: 候補者体験を重視した選考プロセス\n2. **面接官育成**: スキル向上と評価基準の統一\n3. **情報提供**: 求人票と採用HPの充実\n4. **候補者準備**: 面接前の魅力付けと情報提供\n5. **フィードバック**: 建設的な改善提案の提供'
  };
  
  return measuresMap[faq.category] || '1. **現状把握**: 現在の状況と課題の分析\n2. **目標設定**: 具体的で測定可能な目標の設定\n3. **戦略策定**: 目標達成のための具体的な戦略\n4. **実行計画**: 段階的な実施計画の策定\n5. **効果測定**: 定期的な進捗確認と改善';
};

const generateSuccessTips = (faq: QAItem): string => {
  const tipsMap: { [key: string]: string } = {
    '採用ブランディング': '• **一貫性の維持**: すべての発信で統一されたメッセージを心がける\n• **候補者目線**: 企業目線ではなく、候補者が求める情報を提供する\n• **継続性**: 一度の取り組みではなく、継続的な改善を重視する\n• **社内連携**: 各部門との協力体制を構築し、情報の正確性を確保する',
    '採用広報': '• **コンテンツの質**: 量よりも質を重視し、候補者に価値のある情報を提供する\n• **チャネル最適化**: 各チャネルの特性を理解し、最適な使い分けを心がける\n• **候補者体験**: 情報発信から面談、入社まで一貫した体験を設計する\n• **データ活用**: アクセス数や反応を分析し、効果的な改善を行う',
    'スカウト': '• **パーソナライゼーション**: 候補者一人ひとりに合わせたアプローチを心がける\n• **段階的アプローチ**: いきなり採用を求めるのではなく、関係構築から始める\n• **魅力の言語化**: 抽象的な魅力ではなく、具体的で実感できる魅力を表現する\n• **継続的フォロー**: 一度のアプローチで諦めず、長期的な関係構築を目指す',
    '面接・面談': '• **候補者体験**: 選考プロセスを候補者目線で設計し、良い印象を残す\n• **透明性**: 選考基準やプロセスを明確にし、候補者の不安を解消する\n• **双方向コミュニケーション**: 一方的な質問ではなく、対話を通じた相互理解を目指す\n• **建設的フィードバック**: 否定的な評価ではなく、成長につながる提案を提供する'
  };
  
  return tipsMap[faq.category] || '• **計画性**: 明確な目標と戦略を持って取り組む\n• **継続性**: 一度の取り組みで終わらず、継続的な改善を心がける\n• **データ活用**: 定量的な効果測定を行い、根拠に基づいた改善を行う\n• **柔軟性**: 状況の変化に応じて、戦略やアプローチを調整する';
};

const generateCommonMistakes = (faq: QAItem): string => {
  const mistakesMap: { [key: string]: string } = {
    '採用ブランディング': '• **企業目線の表現**: 候補者が求める情報ではなく、企業が伝えたい情報ばかり発信する\n• **一貫性の欠如**: 発信するメッセージが時々で異なり、ブランドイメージが統一されない\n• **抽象的な表現**: 具体的で実感できる魅力ではなく、抽象的な表現に終始する\n• **継続性の欠如**: 一時的な取り組みで終わり、長期的なブランド構築ができない',
    '採用広報': '• **コンテンツの薄さ**: 表面的な情報ばかりで、候補者に価値のある深い内容を提供できない\n• **チャネルの偏り**: 特定のチャネルに依存し、多様な候補者にリーチできない\n• **候補者体験の軽視**: 情報発信は充実しているが、実際の面談や選考プロセスが改善されない\n• **効果測定の不備**: 発信した情報の効果を測定せず、改善の方向性が分からない',
    'スカウト': '• **画一的なアプローチ**: 候補者一人ひとりの違いを考慮せず、同じメッセージでアプローチする\n• **短期的な視点**: 即座の採用を求めるあまり、長期的な関係構築を軽視する\n• **魅力の押し付け**: 候補者のニーズを理解せず、企業の魅力を一方的に押し付ける\n• **フォローアップの不足**: 一度のアプローチで終わり、継続的なコミュニケーションができない',
    '面接・面談': '• **候補者体験の軽視**: 企業の都合ばかりを優先し、候補者の体験を改善しない\n• **選考基準の曖昧さ**: 何を評価しているのかが不明確で、候補者に不安を与える\n• **一方的な質問**: 候補者の話を聞かず、企業が知りたい情報ばかりを聞き出す\n• **建設的でないフィードバック**: 否定的な評価ばかりで、候補者の成長につながる提案をしない'
  };
  
  return mistakesMap[faq.category] || '• **計画性の欠如**: 明確な目標や戦略を持たずに取り組む\n• **継続性の欠如**: 一時的な取り組みで終わり、長期的な改善ができない\n• **データ活用の不足**: 効果測定を行わず、根拠のない改善を行う\n• **柔軟性の欠如**: 状況の変化に応じた調整ができず、非効率な取り組みを続ける';
};

const generateMeasurementAndImprovement = (faq: QAItem): string => {
  const measurementMap: { [key: string]: string } = {
    '採用ブランディング': '• **定量的指標**: 採用サイトのアクセス数、記事の閲覧数、候補者の反応率\n• **定性的指標**: 候補者からのフィードバック、面談での反応、入社後の満足度\n• **改善サイクル**: 3ヶ月ごとの効果測定、半年ごとの戦略見直し、年1回の包括的評価\n• **最適化ポイント**: メッセージの表現、チャネルの選択、発信タイミングの調整',
    '採用広報': '• **定量的指標**: 各チャネルのアクセス数、エンゲージメント率、コンバージョン率\n• **定性的指標**: 候補者からの質問内容、面談での反応、選考継続率\n• **改善サイクル**: 月1回の効果測定、四半期ごとの戦略見直し、半年ごとの包括的評価\n• **最適化ポイント**: コンテンツの質、チャネルの最適化、候補者体験の改善',
    'スカウト': '• **定量的指標**: アプローチ数、反応率、面談実現率、採用成功率\n• **定性的指標**: 候補者からの反応、面談での印象、長期的な関係構築の状況\n• **改善サイクル**: 月1回の効果測定、四半期ごとの戦略見直し、半年ごとの包括的評価\n• **最適化ポイント**: ターゲット設定、アプローチ方法、メッセージの内容',
    '面接・面談': '• **定量的指標**: 面談参加率、選考継続率、採用成功率、入社後の定着率\n• **定性的指標**: 候補者からのフィードバック、面談官の評価、候補者体験の満足度\n• **改善サイクル**: 月1回の効果測定、四半期ごとのプロセス見直し、半年ごとの包括的評価\n• **最適化ポイント**: 面談設計、面談官のスキル、候補者体験の改善'
  };
  
  return measurementMap[faq.category] || '• **定量的指標**: 目標達成率、効率性指標、品質指標\n• **定性的指標**: 顧客満足度、従業員満足度、プロセス改善の効果\n• **改善サイクル**: 定期的な効果測定、戦略の見直し、継続的な改善\n• **最適化ポイント**: プロセスの効率化、品質の向上、顧客体験の改善';
};

const generateNextSteps = (faq: QAItem): string => {
  const nextStepsMap: { [key: string]: string } = {
    '採用ブランディング': '1. **現状分析**: 現在のブランディング状況と課題の洗い出し\n2. **ターゲット設定**: 候補者ペルソナの詳細な定義\n3. **魅力の言語化**: 企業の魅力を候補者目線で表現\n4. **発信戦略**: 適切なチャネルとタイミングでの情報発信\n5. **効果測定**: 定期的な成果確認と改善',
    '採用広報': '1. **コンテンツ戦略**: 記事のテーマと執筆順序の決定\n2. **チャネル最適化**: 各チャネルの特性を活かした情報発信\n3. **候補者体験**: 情報発信から面談までの一貫した体験設計\n4. **社内連携**: 各部門との協力体制の構築\n5. **継続的改善**: 効果測定に基づく定期的な改善',
    'スカウト': '1. **ターゲット分析**: 職種・レベル・経験の詳細な分析\n2. **アプローチ戦略**: パーソナライズされたアプローチ方法の設計\n3. **魅力の言語化**: 企業・職種・ポジションの魅力を効果的に表現\n4. **関係構築**: 段階的な信頼関係の構築方法の確立\n5. **継続的フォロー**: 長期的な関係構築の仕組み化',
    '面接・面談': '1. **プロセス設計**: 候補者体験を重視した選考プロセスの設計\n2. **面接官育成**: スキル向上と評価基準の統一\n3. **情報提供**: 求人票と採用HPの充実\n4. **候補者準備**: 面接前の魅力付けと情報提供の改善\n5. **フィードバック**: 建設的な改善提案の提供方法の確立'
  };
  
  return nextStepsMap[faq.category] || '1. **現状把握**: 現在の状況と課題の詳細な分析\n2. **目標設定**: 具体的で測定可能な目標の設定\n3. **戦略策定**: 目標達成のための具体的な戦略の策定\n4. **実行計画**: 段階的な実施計画の策定\n5. **効果測定**: 定期的な進捗確認と継続的な改善';
};

// 新たな深層的コンテンツ生成関数
const generateDetailedAnalysis = (faq: QAItem): string => {
  const analysisMap: { [key: string]: string } = {
    '採用ブランディング': `**市場環境の分析**:\n現在の採用市場では、優秀な人材の獲得競争が激化しており、単なる求人情報の提供では候補者の心を掴むことができません。企業の魅力を体系的に整理し、候補者の価値観やキャリア目標に合わせて表現することが求められています。\n\n**候補者心理の理解**:\n現代の候補者は、給与や福利厚生だけでなく、企業の理念、成長機会、働く環境の質を重視します。特にミレニアル世代以降は、企業の社会的価値やサステナビリティへの関心が高く、これらの要素を効果的に伝えることが重要です。\n\n**競合他社との差別化**:\n同業他社との差別化を図るためには、自社独自の価値提案（UVP）を明確にし、それを一貫して発信し続ける必要があります。一時的な魅力発信ではなく、長期的なブランド構築が求められています。`,
    '採用広報': `**情報発信の現状分析**:\n従来の採用広報は、企業が伝えたい情報を一方的に発信する傾向がありました。しかし、現代の候補者は多様なチャネルから情報を収集し、企業の真の姿を見極めようとします。\n\n**候補者体験の重要性**:\n採用広報は、情報発信から面談、選考、入社まで一貫した候補者体験を設計する必要があります。各段階で候補者に良い印象を与え、企業への信頼と期待を高めることが重要です。\n\n**コンテンツマーケティングの活用**:\n単なる求人情報ではなく、候補者に価値のあるコンテンツを提供することで、企業の専門性や魅力を効果的に伝えることができます。ブログ、動画、Podcastなど、多様なフォーマットを活用することが求められています。`,
    'スカウト': `**受動的採用の限界**:\n従来の求人応募に依存した受動的な採用活動では、優秀な人材を十分に確保できない状況が生じています。特に、転職意欲の低い優秀な人材に対しては、積極的なアプローチが必要です。\n\n**パーソナライゼーションの重要性**:\n候補者一人ひとりの背景、経験、価値観、キャリア目標を深く理解し、それに合わせたパーソナライズされたアプローチが求められています。画一的なメッセージでは、候補者の心を掴むことができません。\n\n**長期的関係構築の必要性**:\nスカウトは即座の採用を求めるのではなく、長期的な関係構築を目指す必要があります。候補者が転職を検討するタイミングで、信頼関係が構築されていることが重要です。`,
    '面接・面談': `**選考プロセスの現状**:\n多くの企業で、選考プロセスが企業の都合を優先し、候補者体験が軽視されている状況があります。これにより、優秀な候補者が選考を辞退したり、企業への印象が悪化したりするケースが発生しています。\n\n**候補者体験の重要性**:\n選考プロセスは、候補者が企業を評価する重要な機会です。透明性の高い選考基準、丁寧なコミュニケーション、建設的なフィードバックを提供することで、候補者に良い印象を与えることができます。\n\n**面接官の役割**:\n面接官は、候補者の能力や適性を評価するだけでなく、企業の魅力を効果的に伝える役割も担っています。面接官のスキル向上と評価基準の統一が、選考の質向上に直結します。`
  };
  
  return analysisMap[faq.category] || `**現状分析**:\nこの分野における現在の状況と課題を詳細に分析し、改善の方向性を明確にすることが重要です。\n\n**市場環境の理解**:\n業界の動向や競合他社の状況を把握し、自社の立ち位置を明確にすることが求められています。\n\n**課題の特定**:\n表面的な問題だけでなく、根本的な原因を特定し、効果的な対策を講じる必要があります。`;
};

const generatePracticalExamples = (faq: QAItem): string => {
  const examplesMap: { [key: string]: string } = {
    '採用ブランディング': `**成功事例1: 企業理念の言語化**\nあるIT企業では、創業者の想いを基に企業理念を再定義し、それを社員全員が理解できる形で言語化しました。この理念を採用サイトや面談で一貫して伝えることで、理念に共感する候補者の応募が増加し、入社後の定着率も向上しました。\n\n**成功事例2: 社員ストーリーの活用**\n製造業の企業では、入社3年目の社員の成長ストーリーを動画で制作し、採用サイトで公開しました。具体的な成長過程ややりがいを伝えることで、候補者が自身のキャリアをイメージしやすくなり、応募の質が向上しました。\n\n**成功事例3: 一貫性のあるブランドメッセージ**\nサービス業の企業では、採用広報、企業広報、商品広報で統一されたブランドメッセージを使用し、企業の一貫性を印象付けました。これにより、候補者からの企業への信頼が高まり、選考継続率が向上しました。`,
    '採用広報': `**成功事例1: 多チャネル戦略**\nある企業では、ブログ、SNS、動画、Podcastを活用した多チャネル戦略を展開しました。各チャネルの特性を活かしたコンテンツを提供することで、異なる層の候補者にリーチし、応募者の多様性が向上しました。\n\n**成功事例2: 社員インタビューの活用**\nIT企業では、各職種の社員にインタビューを行い、仕事の内容ややりがいを動画で公開しました。リアルな社員の声を伝えることで、候補者が企業の働く環境を具体的にイメージできるようになり、面談参加率が向上しました。\n\n**成功事例3: 候補者体験の改善**\nある企業では、面談から入社まで一貫した候補者体験を設計しました。面談後の丁寧なフォローアップ、入社前の準備支援、入社後のオンボーディングを充実させることで、入社後の定着率が大幅に向上しました。`,
    'スカウト': `**成功事例1: パーソナライズされたアプローチ**\nある企業では、候補者の経歴や興味関心を詳しく調査し、それに合わせたパーソナライズされたメッセージを作成しました。候補者の価値観やキャリア目標に合致した内容を伝えることで、反応率が従来の3倍に向上しました。\n\n**成功事例2: 段階的な関係構築**\nIT企業では、候補者との関係構築を段階的に行いました。最初は情報提供から始め、徐々に企業の魅力を伝え、最終的に面談を提案するアプローチを取ることで、信頼関係を構築し、面談実現率が向上しました。\n\n**成功事例3: 継続的なフォローアップ**\nある企業では、一度のアプローチで終わらず、定期的なフォローアップを行いました。企業の最新情報や業界動向を共有することで、候補者との関係を維持し、転職を検討するタイミングでの連絡が増加しました。`,
    '面接・面談': `**成功事例1: 候補者体験の最適化**\nある企業では、選考プロセスを候補者目線で再設計しました。面接の日程調整を柔軟に行い、面接官の準備を徹底し、丁寧なフィードバックを提供することで、候補者からの評価が向上し、選考継続率が改善しました。\n\n**成功事例2: 面接官のスキル向上**\n製造業の企業では、面接官のスキル向上プログラムを実施しました。面接技術の研修、評価基準の統一、定期的なフィードバックを行うことで、面接の質が向上し、適切な人材選考ができるようになりました。\n\n**成功事例3: 透明性の確保**\nサービス業の企業では、選考基準とプロセスを明確にし、候補者に事前に説明しました。何を評価しているのか、どのような流れで選考が進むのかを明確に伝えることで、候補者の不安を解消し、面談でのパフォーマンスが向上しました。`
  };
  
  return examplesMap[faq.category] || `**一般的な成功事例**:\nこの分野では、明確な目標設定と戦略的なアプローチが成功の鍵となっています。\n\n**ベストプラクティス**:\n業界の標準的な取り組みを参考にし、自社の状況に合わせてカスタマイズすることが重要です。\n\n**継続的な改善**:\n一度の成功で満足せず、継続的な改善と最適化を行うことで、さらなる成果を上げることができます。`;
};

const generateIndustryTrends = (faq: QAItem): string => {
  const trendsMap: { [key: string]: string } = {
    '採用ブランディング': `**デジタル化の進展**:\n採用活動のデジタル化が急速に進んでおり、オンラインでの魅力発信が重要になっています。VR/ARを活用した企業見学、オンライン面談、デジタル採用資料など、新しい技術を活用したブランディングが求められています。\n\n**パーソナライゼーションの強化**:\n候補者一人ひとりのニーズや価値観に合わせたパーソナライズされた情報提供が重要になっています。AIを活用した候補者分析や、個別最適化されたコンテンツの提供が、採用の成功に直結するようになっています。\n\n**サステナビリティへの関心**:\n特に若い世代を中心に、企業の社会的価値やサステナビリティへの関心が高まっています。ESG（環境・社会・ガバナンス）への取り組みを効果的に伝えることが、企業の魅力向上につながっています。`,
    '採用広報': `**コンテンツマーケティングの重要性**:\n単なる求人情報ではなく、候補者に価値のあるコンテンツを提供することが重要になっています。業界の専門知識、キャリアアドバイス、企業文化の紹介など、候補者が求む情報を継続的に発信することが求められています。\n\n**動画コンテンツの活用**:\n動画コンテンツの需要が高まっており、企業紹介動画、社員インタビュー動画、仕事紹介動画などが効果的です。特に、短時間で企業の魅力を伝えられる動画は、候補者の関心を集めやすくなっています。\n\n**ソーシャルメディアの戦略的活用**:\nLinkedIn、Twitter、Instagramなどのソーシャルメディアを戦略的に活用することが重要です。各プラットフォームの特性を理解し、適切なコンテンツとタイミングで発信することで、効果的なリーチが可能になります。`,
    'スカウト': `**AI・データ活用の進展**:\nAIを活用した候補者分析や、データドリブンなアプローチが重要になっています。候補者の経歴、スキル、興味関心をデータで分析し、最適なアプローチ方法を決定することが求められています。\n\n**パッシブ候補者へのアプローチ**:\n転職意欲の低い優秀な人材（パッシブ候補者）へのアプローチが重要になっています。これらの候補者は、適切なタイミングとアプローチ方法でアプローチすることで、高い確率で反応を得ることができます。\n\n**長期的関係構築の重視**:\n即座の採用を求めるのではなく、長期的な関係構築を重視するアプローチが求められています。候補者が転職を検討するタイミングで、既に信頼関係が構築されていることが重要です。`,
    '面接・面談': `**オンライン面談の普及**:\nコロナ禍を契機に、オンライン面談が急速に普及しています。オンライン面談の特性を理解し、効果的な実施方法を確立することが重要になっています。\n\n**候補者体験の重視**:\n候補者体験の質が、採用の成功に直結するようになっています。面談の日程調整、面接官の準備、フィードバックの提供など、各段階での候補者体験を最適化することが求められています。\n\n**多様性・包括性の重視**:\n多様な背景を持つ候補者を受け入れるため、面接プロセスの多様性・包括性を確保することが重要です。無意識の偏見を排除し、公平で透明性の高い選考プロセスを構築することが求められています。`
  };
  
  return trendsMap[faq.category] || `**業界全体の動向**:\nこの分野では、デジタル化の進展とパーソナライゼーションの強化が重要なトレンドとなっています。\n\n**技術革新の影響**:\nAIやデータ分析技術の進歩により、より効果的なアプローチが可能になっています。\n\n**顧客ニーズの変化**:\n候補者のニーズや価値観が変化しており、それに合わせた対応が求められています。`;
};

const generateExpertInsights = (faq: QAItem): string => {
  const insightsMap: { [key: string]: string } = {
    '採用ブランディング': `**専門家の視点**:\n採用ブランディングの専門家によると、企業の魅力を効果的に伝えるためには、候補者目線での価値提案が重要です。企業が伝えたい情報ではなく、候補者が求める情報を提供することが成功の鍵となります。\n\n**業界のベストプラクティス**:\n成功している企業の共通点として、一貫性のあるブランドメッセージ、継続的な魅力発信、候補者体験の重視が挙げられます。これらの要素を体系的に実装することで、持続的な採用の成功が可能になります。\n\n**将来の展望**:\n今後は、AIを活用したパーソナライゼーション、VR/ARを活用した没入型体験、データドリブンな戦略立案が重要になると予想されています。`,
    '採用広報': `**専門家の視点**:\n採用広報の専門家は、コンテンツの質と一貫性の重要性を強調しています。単なる情報発信ではなく、候補者に価値のあるコンテンツを継続的に提供することが、長期的な採用の成功につながります。\n\n**業界のベストプラクティス**:\n効果的な採用広報を行う企業は、多チャネル戦略、候補者体験の設計、データ活用を重視しています。各チャネルの特性を理解し、候補者のニーズに合わせた最適なアプローチを取ることが重要です。\n\n**将来の展望**:\n今後は、AIを活用したコンテンツ最適化、パーソナライズされた情報提供、没入型コンテンツの活用が重要になると予想されています。`,
    'スカウト': `**専門家の視点**:\nスカウトの専門家によると、成功の鍵は候補者との長期的な関係構築にあります。即座の採用を求めるのではなく、候補者のキャリア成長を支援する姿勢でアプローチすることが重要です。\n\n**業界のベストプラクティス**:\n効果的なスカウトを行う企業は、詳細なターゲット分析、パーソナライズされたアプローチ、継続的なフォローアップを重視しています。候補者一人ひとりの背景とニーズを深く理解することが成功の前提条件です。\n\n**将来の展望**:\n今後は、AIを活用した候補者分析、予測分析によるアプローチ最適化、データドリブンな戦略立案が重要になると予想されています。`,
    '面接・面談': `**専門家の視点**:\n面接・面談の専門家は、候補者体験の重要性を強調しています。選考プロセスは企業を評価する重要な機会であり、候補者に良い印象を与えることが採用の成功につながります。\n\n**業界のベストプラクティス**:\n効果的な面接・面談を行う企業は、透明性の高い選考基準、面接官のスキル向上、候補者体験の最適化を重視しています。公平で透明性の高い選考プロセスを構築することが重要です。\n\n**将来の展望**:\n今後は、AIを活用した面接支援、オンライン面談の最適化、多様性・包括性の確保が重要になると予想されています。`
  };
  
  return insightsMap[faq.category] || `**専門的な知見**:\nこの分野では、継続的な学習と実践が専門性の向上につながります。\n\n**業界の動向**:\n業界の最新動向を把握し、ベストプラクティスを学ぶことが重要です。\n\n**将来の展望**:\n技術革新や市場環境の変化を予測し、将来を見据えた戦略を立てることが求められています。`;
};

const generateStrategicApproach = (faq: QAItem): string => {
  const strategicMap: { [key: string]: string } = {
    '採用ブランディング': `**戦略的フレームワーク**:\n採用ブランディングでは、STP（Segmentation, Targeting, Positioning）フレームワークを活用することが効果的です。候補者市場を細分化し、ターゲットを特定し、競合他社との差別化を図ることで、効果的なブランディング戦略を構築できます。\n\n**長期的視点**:\n採用ブランディングは短期的な取り組みではなく、長期的なブランド構築が求められます。企業の成長戦略と連携し、持続可能なブランディング戦略を策定することが重要です。\n\n**統合的なアプローチ**:\n採用ブランディングは、企業ブランディング、商品ブランディングと統合的に取り組むことで、より効果的な結果を得ることができます。企業全体のブランド戦略と整合性を保つことが重要です。`,
    '採用広報': `**戦略的フレームワーク**:\n採用広報では、AIDA（Attention, Interest, Desire, Action）フレームワークを活用することが効果的です。候補者の注意を引き、興味を喚起し、欲求を高め、行動を促す段階的なアプローチを取ることで、効果的な採用広報が実現できます。\n\n**コンテンツ戦略**:\n採用広報の成功には、体系的で継続的なコンテンツ戦略が重要です。候補者のニーズに合わせたコンテンツを、適切なチャネルとタイミングで提供することが求められています。\n\n**データドリブンな改善**:\n採用広報の効果を定量的に測定し、データに基づいた継続的な改善を行うことが重要です。アクセス数、エンゲージメント率、コンバージョン率などの指標を活用して、戦略の最適化を図ることができます。`,
    'スカウト': `**戦略的フレームワーク**:\nスカウトでは、RADAR（Research, Approach, Develop, Act, Review）フレームワークを活用することが効果的です。候補者の調査、アプローチ、関係構築、行動促進、振り返りを体系的に行うことで、効果的なスカウト活動が実現できます。\n\n**ターゲット戦略**:\nスカウトの成功には、明確で詳細なターゲット設定が重要です。職種、レベル、経験、価値観など、多角的な観点からターゲットを定義し、それに合わせたアプローチ戦略を策定することが求められています。\n\n**関係構築戦略**:\nスカウトは即座の採用を求めるのではなく、長期的な関係構築を目指す戦略的アプローチです。候補者のキャリア成長を支援する姿勢でアプローチし、信頼関係を構築することが重要です。`,
    '面接・面談': `**戦略的フレームワーク**:\n面接・面談では、STAR（Situation, Task, Action, Result）フレームワークを活用することが効果的です。候補者の具体的な経験や成果を体系的に評価し、適切な人材選考を実現できます。\n\n**プロセス設計**:\n面接・面談の成功には、候補者体験を重視したプロセス設計が重要です。選考基準の明確化、面接官のスキル向上、フィードバックの提供など、各段階での体験を最適化することが求められています。\n\n**品質管理**:\n面接・面談の品質を継続的に向上させるため、定期的な評価と改善を行うことが重要です。面接官のトレーニング、評価基準の統一、プロセスの最適化を継続的に実施することが求められています。`
  };
  
  return strategicMap[faq.category] || `**戦略的思考**:\nこの分野では、短期的な成果だけでなく、長期的な戦略的視点が重要です。\n\n**体系的アプローチ**:\n明確なフレームワークと戦略を持って取り組むことで、効果的な結果を得ることができます。\n\n**継続的改善**:\n一度の成功で満足せず、継続的な改善と最適化を行うことが、長期的な成功につながります。`;
};

const generateRiskManagement = (faq: QAItem): string => {
  const riskMap: { [key: string]: string } = {
    '採用ブランディング': `**ブランドイメージのリスク**:\n採用ブランディングでは、発信する情報と実際の企業文化や働く環境に乖離がある場合、候補者からの信頼を失うリスクがあります。真実性と一貫性を保つことが重要です。\n\n**競合他社との差別化リスク**:\n同業他社との差別化が不十分な場合、候補者から選ばれないリスクがあります。自社独自の価値提案を明確にし、効果的に伝えることが求められています。\n\n**長期的なブランド構築のリスク**:\n短期的な成果を求めるあまり、長期的なブランド構築ができないリスクがあります。継続的な取り組みと投資が重要です。`,
    '採用広報': `**コンテンツの質のリスク**:\n採用広報では、表面的で価値の低いコンテンツを提供することで、候補者からの評価が下がるリスクがあります。質の高い、候補者に価値のあるコンテンツを提供することが重要です。\n\n**チャネル最適化のリスク**:\n特定のチャネルに依存することで、多様な候補者にリーチできないリスクがあります。各チャネルの特性を理解し、効果的な使い分けを行うことが求められています。\n\n**候補者体験のリスク**:\n情報発信は充実しているが、実際の面談や選考プロセスが改善されない場合、候補者体験の悪化につながるリスクがあります。一貫した体験設計が重要です。`,
    'スカウト': `**パーソナライゼーションのリスク**:\nスカウトでは、画一的なアプローチを行うことで、候補者からの反応が得られないリスクがあります。候補者一人ひとりの背景とニーズを理解し、パーソナライズされたアプローチを行うことが重要です。\n\n**短期的視点のリスク**:\n即座の採用を求めるあまり、長期的な関係構築を軽視することで、候補者との信頼関係が構築できないリスクがあります。長期的な視点でのアプローチが重要です。\n\n**フォローアップ不足のリスク**:\n一度のアプローチで終わることで、候補者との関係が途切れるリスクがあります。継続的なフォローアップと関係維持が重要です。`,
    '面接・面談': `**候補者体験のリスク**:\n面接・面談では、企業の都合を優先することで、候補者体験が悪化し、優秀な候補者が選考を辞退するリスクがあります。候補者目線でのプロセス設計が重要です。\n\n**選考基準の曖昧さのリスク**:\n選考基準が不明確な場合、候補者に不安を与え、面接でのパフォーマンスが低下するリスクがあります。明確で透明性の高い選考基準の設定が重要です。\n\n**面接官のスキル不足のリスク**:\n面接官のスキルが不足している場合、適切な人材選考ができず、採用の質が低下するリスクがあります。面接官の継続的なスキル向上が重要です。`
  };
  
  return riskMap[faq.category] || `**一般的なリスク**:\nこの分野では、計画性の欠如や継続性の欠如が主要なリスクとなります。\n\n**リスク軽減策**:\n明確な戦略と継続的な改善を行うことで、リスクを軽減することができます。\n\n**継続的モニタリング**:\n定期的な効果測定と改善を行うことで、リスクの早期発見と対応が可能になります。`;
};

const generateLongTermPerspective = (faq: QAItem): string => {
  const longTermMap: { [key: string]: string } = {
    '採用ブランディング': `**持続可能なブランド構築**:\n採用ブランディングは、企業の長期的な成長戦略の一部として位置づける必要があります。短期的な成果を求めるのではなく、持続可能なブランド構築を目指すことが重要です。\n\n**企業文化の醸成**:\n採用ブランディングを通じて、企業文化の醸成と強化を図ることができます。社員の価値観の統一、企業理念の浸透、組織の一体感の向上につながります。\n\n**長期的な人材確保**:\n効果的な採用ブランディングにより、長期的に優秀な人材を確保できる基盤を構築できます。企業の成長と発展に必要な人材を継続的に確保することが可能になります。`,
    '採用広報': `**持続可能な採用基盤**:\n採用広報は、企業の持続可能な採用基盤を構築する重要な要素です。継続的な情報発信と候補者体験の改善により、安定した人材確保が可能になります。\n\n**企業の成長支援**:\n効果的な採用広報により、企業の成長に必要な人材を継続的に確保できます。企業の事業拡大や新規事業展開に必要な人材を、適切なタイミングで確保することが可能になります。\n\n**長期的なブランド価値**:\n採用広報を通じて構築された企業ブランドは、長期的な価値を持ちます。企業の社会的評価の向上、優秀な人材の継続的な確保、企業価値の向上につながります。`,
    'スカウト': `**長期的な人材ネットワーク**:\nスカウトは、長期的な人材ネットワークの構築を目指すべきです。即座の採用を求めるのではなく、候補者との長期的な関係構築により、将来の人材確保の基盤を構築できます。\n\n**候補者のキャリア支援**:\nスカウトを通じて、候補者のキャリア成長を支援することができます。候補者の価値観やキャリア目標を理解し、適切なタイミングでの転職をサポートすることで、長期的な信頼関係を構築できます。\n\n**戦略的人材確保**:\nスカウトにより、戦略的に必要な人材を確保できる基盤を構築できます。企業の長期的な成長戦略に必要な人材を、適切なタイミングで確保することが可能になります。`,
    '面接・面談': `**長期的な人材選考基盤**:\n面接・面談は、企業の長期的な人材選考基盤を構築する重要な要素です。継続的な改善と最適化により、適切な人材選考が可能になります。\n\n**企業の成長支援**:\n効果的な面接・面談により、企業の成長に適した人材を継続的に選考できます。企業の事業戦略に合致した人材を、適切な基準で選考することが可能になります。\n\n**長期的な企業価値**:\n面接・面談を通じて構築された企業の評価は、長期的な価値を持ちます。候補者からの企業評価の向上、優秀な人材の継続的な確保、企業価値の向上につながります。`
  };
  
  return longTermMap[faq.category] || `**長期的な視点**:\nこの分野では、短期的な成果だけでなく、長期的な価値創造が重要です。\n\n**持続可能性**:\n一度の成功で終わらず、持続可能な取り組みを継続することが重要です。\n\n**将来への投資**:\n現在の取り組みが、将来の成長と発展につながる投資として位置づけることが重要です。`;
};

const MainApp: React.FC = () => {
  const { currentUser, logout, isAdmin } = useAuth();
  const [selectedGranularity, setSelectedGranularity] = useState<Granularity>('contextual');
  const [question, setQuestion] = useState<string>('');
  const [answer, setAnswer] = useState<string | null>(null);
  const [questionSearched, setQuestionSearched] = useState<string | null>(null);
  const [isLoading, setIsLoading] = useState<boolean>(false);
  const [suggestedQuestions, setSuggestedQuestions] = useState<string[]>([]);
  const [userInsights, setUserInsights] = useState<string[]>([]);

  const handleQuestionSubmit = async (submittedQuestion: string) => {
    setIsLoading(true);
    setQuestionSearched(submittedQuestion);
    setAnswer(null);
    setSuggestedQuestions([]);
    setUserInsights([]);

    try {
      // 実際のAI回答生成ロジック
      await new Promise(resolve => setTimeout(resolve, 1500));
      
      // 質問に最も関連するFAQを検索
      const relevantFAQ = findMostRelevantFAQ(submittedQuestion);
      
      if (relevantFAQ) {
        // 詳細度に応じた回答を生成
        const answer = generateAnswerByGranularity(relevantFAQ, selectedGranularity);
        setAnswer(answer);
        
        // 関連するフォローアップ質問を生成
        const followUpQuestions = generateFollowUpQuestions(relevantFAQ, submittedQuestion);
        setSuggestedQuestions(followUpQuestions);
        
        // ユーザーインサイトを生成
        const insights = generateUserInsights(relevantFAQ, submittedQuestion);
        setUserInsights(insights);
      } else {
        // 関連するFAQが見つからない場合の回答
        const fallbackAnswer = generateFallbackAnswer(submittedQuestion, selectedGranularity);
        setAnswer(fallbackAnswer);
        
        setSuggestedQuestions([
          '採用広報について詳しく教えてください',
          'スカウトメールの効果的な方法は？',
          '採用ブランディングの進め方は？'
        ]);
        
        setUserInsights([
          '人事関連の質問に積極的に関心を持たれているようですね',
          'より具体的なアドバイスが必要でしょうか？'
        ]);
      }

    } catch (error) {
      console.error('AI回答の取得に失敗しました:', error);
      setAnswer('申し訳ございません。回答の取得に失敗しました。もう一度お試しください。');
    } finally {
      setIsLoading(false);
    }
  };

  const handleFaqSelect = (selectedQuestion: string) => {
    setQuestion(selectedQuestion);
    handleQuestionSubmit(selectedQuestion);
  };

  const handleLogout = async () => {
    await logout();
  };

  return (
    <div className="min-h-screen bg-gray-50">
      {/* ヘッダー */}
      <header className="bg-white shadow-sm border-b">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div className="flex justify-between items-center h-16">
            <div className="flex items-center">
              <h1 className="text-2xl font-bold text-gray-900">HR Q&A アシスタント</h1>
            </div>
            <div className="flex items-center space-x-4">
              <span className="text-sm text-gray-600">
                ようこそ、{currentUser?.displayName || currentUser?.email}さん
              </span>
              {isAdmin && (
                <button
                  onClick={() => window.location.href = '/admin'}
                  className="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium transition-colors duration-200"
                >
                  管理画面
                </button>
              )}
              <button
                onClick={handleLogout}
                className="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-md text-sm font-medium transition-colors duration-200"
              >
                ログアウト
              </button>
            </div>
          </div>
        </div>
      </header>

      {/* メインコンテンツ */}
      <main className="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
        <div className="bg-white shadow rounded-lg p-6">
          <div className="mb-6">
            <h2 className="text-lg font-medium text-gray-900 mb-4">
              人事関連の質問にお答えします
            </h2>
            <p className="text-gray-600">
              人事評価、採用、労務管理など、人事に関する質問をAIが詳しくお答えします。
            </p>
          </div>

          {/* 回答の詳細度選択 */}
          <AnswerGranularitySelector
            selectedGranularity={selectedGranularity}
            onGranularityChange={setSelectedGranularity}
            disabled={isLoading}
          />

          {/* 質問入力 */}
          <QuestionInput
            onSubmit={handleQuestionSubmit}
            isLoading={isLoading}
            initialQuestion={question}
          />

          {/* 回答表示 */}
          <AnswerDisplay
            answer={answer}
            questionSearched={questionSearched}
          />

          {/* フォローアップ質問 */}
          <SuggestedFollowUpQuestions
            questions={suggestedQuestions}
            onQuestionSelect={handleQuestionSubmit}
            isLoading={isLoading}
          />

          {/* ユーザーインサイト */}
          <UserInsightDisplay
            insightText={userInsights}
            isLoading={isLoading}
          />

          {/* FAQ */}
          <div className="mt-8">
            <h3 className="text-lg font-medium text-gray-900 mb-4">よくある質問 (FAQ)</h3>
            <p className="text-sm text-gray-600 mb-4">
              クリックすると、選択された回答粒度でAIに質問します。
            </p>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              {KNOWLEDGE_BASE.map((qaItem: QAItem) => (
                <FaqItem
                  key={qaItem.id}
                  qaItem={qaItem}
                  onQuestionSelect={handleFaqSelect}
                />
              ))}
            </div>
          </div>
        </div>
      </main>
    </div>
  );
};

export default MainApp;
